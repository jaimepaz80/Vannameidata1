<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, where, orderBy, getDocs, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBBgvzjBdgvSlHiIqyGL3abcG6fHFS-m6I",
      authDomain: "vannamei--data.firebaseapp.com",
      projectId: "vannamei--data",
      storageBucket: "vannamei--data.firebasestorage.app",
      messagingSenderId: "758235885282",
      appId: "1:758235885282:web:a7ad387667a05a1f7778bb"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // UTILS
    window.togglePass = () => { const x = document.getElementById("password"); x.type = x.type === "password" ? "text" : "password"; };
    window.nav = (screen) => {
        document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
        document.getElementById(screen).classList.remove('hidden');
        if(screen === 'reports-screen') {
            loadPools('alim-pool-filter');
            loadPools('ins-pool-filter');
        }
    };
    window.goBack = () => nav('dashboard-screen');
    window.logout = () => { auth.signOut(); nav('login-screen'); };
    
    const today = new Date().toISOString().split('T')[0];
    ['feed-date','water-date','bio-date','st-date','in-date','alim-start','alim-end','ins-start','ins-end'].forEach(id => {
        const el = document.getElementById(id); if(el) el.value = today;
    });

    // LOGIN
    document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
            await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value);
            document.getElementById('user-display').innerText = auth.currentUser.email;
            nav('dashboard-screen');
        } catch(err) { document.getElementById('login-error').style.display='block'; }
    });

    // --- CARGA DE PISCINAS EN SELECTS ---
    window.loadPools = async (elemId) => {
        const sel = document.getElementById(elemId);
        sel.innerHTML = '<option value="">Cargando...</option>';
        try {
            const docSnap = await getDoc(doc(db, "config", "general"));
            sel.innerHTML = (elemId.includes('filter')) ? '<option value="all">Todas las Piscinas</option>' : '<option value="">Seleccione...</option>';
            
            if(docSnap.exists()){
                const pools = docSnap.data().pools || [];
                pools.sort((a, b) => parseInt(a.id) - parseInt(b.id));
                
                pools.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id; 
                    opt.text = "Piscina " + p.id;
                    sel.appendChild(opt);
                });
            }
        } catch(e){ console.error(e); sel.innerHTML = '<option>Error</option>'; }
    };

    // --- GUARDADOS ---
    window.renderPools = (n) => {
        const c = document.getElementById('cfg-pools'); c.innerHTML='';
        for(let i=1;i<=n;i++) c.innerHTML+=`<div class="input-group"><label>Piscina ${i} (Has)</label><input class="pool-sz" data-id="${i}" type="number"></div>`;
    };

    window.saveConfig = async () => {
        const pools = Array.from(document.querySelectorAll('.pool-sz')).map(i=>({id:i.dataset.id, area:i.value}));
        await setDoc(doc(db,"config","general"), {name: document.getElementById('cfg-name').value, pools});
        alert("Configuración Guardada. Piscinas actualizadas."); 
        goBack();
    };
    
    window.saveFeed = async () => {
        await addDoc(collection(db,"feed"), {
            date: document.getElementById('feed-date').value,
            pool: document.getElementById('feed-pool').value,
            rec: Number(document.getElementById('feed-rec').value),
            cons: Number(document.getElementById('feed-cons').value)
        }); alert("Guardado"); goBack();
    };
    
    window.saveBio = async () => {
        await addDoc(collection(db,"bio"), {
            date: document.getElementById('bio-date').value,
            pool: document.getElementById('bio-pool').value,
            type: document.getElementById('bio-type').value,
            count: Number(document.getElementById('bio-count').value),
            weight: Number(document.getElementById('bio-weight').value),
            timestamp: new Date()
        }); alert("Guardado"); goBack();
    };

    window.saveStatus = async () => {
        await addDoc(collection(db,"status"), {
            date: document.getElementById('st-date').value,
            pool: document.getElementById('status-pool').value,
            status: document.getElementById('st-val').value,
            timestamp: new Date()
        }); alert("Guardado"); goBack();
    };

    window.saveInput = async () => {
        await addDoc(collection(db,"inputs"), {
            date: document.getElementById('in-date').value,
            pool: document.getElementById('input-pool').value,
            prod: document.getElementById('in-prod').value,
            qty: Number(document.getElementById('in-qty').value),
            unit: document.getElementById('in-unit').value
        }); alert("Guardado"); goBack();
    };
    
    window.saveWater = async () => {
        await addDoc(collection(db,"water"), {
            date: document.getElementById('water-date').value,
            pool: document.getElementById('water-pool').value,
            o2: Number(document.getElementById('w-o2').value),
            ph: Number(document.getElementById('w-ph').value),
            temp: Number(document.getElementById('w-temp').value),
            sal: Number(document.getElementById('w-sal').value),
            secchi: Number(document.getElementById('w-secchi').value),
            tan: Number(document.getElementById('w-tan').value),
            no2: Number(document.getElementById('w-no2').value)
        }); alert("Guardado"); goBack();
    };


    // --- REPORTES ---
    window.switchTab = (id) => {
        document.querySelectorAll('.report-view').forEach(d=>d.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        document.getElementById(id).classList.remove('hidden');
        event.target.classList.add('active');
    };

    window.runAlimReport = async () => {
        const start = document.getElementById('alim-start').value;
        const end = document.getElementById('alim-end').value;
        const pool = document.getElementById('alim-pool-filter').value;
        const tbody = document.getElementById('alim-tbody');
        tbody.innerHTML = '<tr><td colspan="4">Cargando...</td></tr>';

        let q = query(collection(db, "feed"), where("date", ">=", start), where("date", "<=", end), orderBy("date", "desc"));
        if(pool !== 'all') {
            q = query(collection(db, "feed"), where("pool", "==", pool), where("date", ">=", start), where("date", "<=", end), orderBy("date", "desc"));
        }

        try {
            const snap = await getDocs(q);
            tbody.innerHTML = '';
            if(snap.empty) { tbody.innerHTML = '<tr><td colspan="4">Sin datos</td></tr>'; return; }
            
            snap.forEach(doc => {
                const d = doc.data();
                tbody.innerHTML += `<tr><td>${d.date}</td><td>P${d.pool}</td><td>${d.rec}</td><td>${d.cons}</td></tr>`;
            });
        } catch(e) { console.error(e); tbody.innerHTML = '<tr><td colspan="4">Error al cargar (Posible falta índice)</td></tr>'; }
    };

    window.runBioReport = async () => {
        const tbody = document.getElementById('bio-tbody');
        tbody.innerHTML = '<tr><td colspan="4">Calculando...</td></tr>';
        
        try {
            const cfg = await getDoc(doc(db, "config", "general"));
            if(!cfg.exists()) return;
            const pools = cfg.data().pools;
            tbody.innerHTML = '';

            for(const p of pools) {
                const q = query(collection(db, "bio"), where("pool", "==", p.id), orderBy("date", "desc"), limit(1));
                const snap = await getDocs(q);
                
                if(!snap.empty) {
                    const d = snap.docs[0].data();
                    const biomass = ((d.count * d.weight)/1000).toFixed(2);
                    tbody.innerHTML += `<tr><td>P${p.id}</td><td>${d.count}</td><td>${d.weight}g</td><td>${biomass}</td></tr>`;
                } else {
                    tbody.innerHTML += `<tr><td>P${p.id}</td><td colspan="3">- Sin datos -</td></tr>`;
                }
            }
        } catch(e){ console.error(e); }
    };

    window.runStatusReport = async () => {
        const tbody = document.getElementById('estatus-tbody');
        tbody.innerHTML = '<tr><td colspan="3">Cargando...</td></tr>';
        
        try {
            const cfg = await getDoc(doc(db, "config", "general"));
            if(!cfg.exists()) return;
            const pools = cfg.data().pools;
            tbody.innerHTML = '';

            for(const p of pools) {
                const q = query(collection(db, "status"), where("pool", "==", p.id), orderBy("timestamp", "desc"), limit(1));
                const snap = await getDocs(q);
                let status = "Desconocido";
                let date = "-";
                
                if(!snap.empty) {
                    status = snap.docs[0].data().status;
                    date = snap.docs[0].data().date;
                }
                tbody.innerHTML += `<tr><td>P${p.id}</td><td><b>${status}</b></td><td>${date}</td></tr>`;
            }
        } catch(e){ console.error(e); }
    };

    window.runInputReport = async () => {
        const start = document.getElementById('ins-start').value;
        const end = document.getElementById('ins-end').value;
        const pool = document.getElementById('ins-pool-filter').value;
        const tbody = document.getElementById('ins-tbody');
        tbody.innerHTML = '<tr><td colspan="4">Cargando...</td></tr>';

        let q = query(collection(db, "inputs"), where("date", ">=", start), where("date", "<=", end));
        if(pool !== 'all') q = query(collection(db, "inputs"), where("pool", "==", pool), where("date", ">=", start), where("date", "<=", end));

        try {
            const snap = await getDocs(q);
            tbody.innerHTML = '';
            if(snap.empty) { tbody.innerHTML = '<tr><td colspan="4">Sin datos</td></tr>'; return; }
            
            snap.forEach(doc => {
                const d = doc.data();
                tbody.innerHTML += `<tr><td>${d.date}</td><td>P${d.pool}</td><td>${d.prod}</td><td>${d.qty} ${d.unit || ''}</td></tr>`;
            });
        } catch(e){ console.error(e); }
    };

    // --- CARGAR CONFIGURACIÓN (FUNCIÓN CORREGIDA) ---
    window.loadConfig = async () => {
        try {
            // 1. Obtener documento de Firebase
            const docRef = doc(db, "config", "general");
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                
                // 2. Llenar Nombre de Granja
                document.getElementById('cfg-name').value = data.name || '';
                
                // 3. Preparar Piscinas
                const pools = data.pools || [];
                const count = pools.length;
                
                // Llenar input de cantidad
                document.getElementById('cfg-count').value = count;

                // 4. Renderizar inputs (crear los huecos)
                renderPools(count);

                // 5. Llenar los valores de hectáreas en los inputs recién creados
                pools.forEach(p => {
                    const input = document.querySelector(`.pool-sz[data-id="${p.id}"]`);
                    if (input) {
                        input.value = p.area;
                    }
                });
            }
        } catch (error) {
            console.error("Error al cargar configuración:", error);
            alert("No se pudo cargar la configuración de la nube.");
        }
    };

</script>
