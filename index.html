<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vannamei Data - Gesti√≥n Acu√≠cola</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- ESTILOS (CSS) --- */
        :root { --primary-color: #006064; --secondary-color: #0097a7; --bg-color: #f4f6f8; --text-color: #333; --white: #ffffff; --alarm-color: #d32f2f; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-color); margin: 0; padding: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; color: var(--text-color); }
        .app-container { width: 100%; max-width: 480px; background: var(--white); min-height: 100vh; box-shadow: 0 0 20px rgba(0,0,0,0.1); position: relative; display: flex; flex-direction: column; }
        .hidden { display: none !important; }
        
        /* Login */
        #login-screen { flex: 1; display: flex; flex-direction: column; justify-content: center; padding: 2rem; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; }
        h1, h2, h3 { text-align: center; margin-bottom: 1rem; }
        .input-group { position: relative; margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; box-sizing: border-box; background: #fff; }
        input:focus, select:focus { outline: 2px solid var(--secondary-color); border-color: transparent; }
        
        button.primary-btn { width: 100%; padding: 14px; background-color: var(--primary-color); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        button:disabled { opacity: 0.7; cursor: not-allowed; }
        
        .toggle-password { position: absolute; right: 10px; top: 38px; cursor: pointer; background: none; border: none; color: #666; }
        #login-screen .toggle-password { top: 50%; transform: translateY(-50%); color: #ddd; }
        
        /* Headers */
        .screen-header { background-color: var(--primary-color); color: white; padding: 1rem; display: flex; align-items: center; position: sticky; top: 0; z-index: 10; }
        .back-btn { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; margin-right: 1rem; padding: 0 10px; }
        .content-area { padding: 1.5rem; flex: 1; overflow-y: auto; padding-bottom: 4rem; }
        
        /* Dashboard Grid */
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .dash-btn { background-color: var(--white); border: 1px solid #ddd; border-radius: 12px; padding: 1.5rem 1rem; text-align: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.05); color: var(--primary-color); font-weight: 600; display: flex; align-items: center; justify-content: center; }
        
        /* Config & Forms */
        .pool-input-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; background: #f9f9f9; padding: 8px; border-radius: 6px; }
        .pool-input-row label { margin: 0; font-weight: normal; }
        .pool-input-row input { width: 80px; text-align: center; }
        
        .chemistry-section { border: 1px solid #e0e0e0; border-radius: 8px; padding: 10px; margin-top: 15px; background-color: #fafafa; }
        .chemistry-title { font-weight: bold; color: var(--primary-color); margin-bottom: 10px; display: block; border-bottom: 1px solid #ddd; padding-bottom: 5px; }

        /* TABLA DE BIOMETR√çAS */
        .bio-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.85rem; }
        .bio-table th { background: var(--primary-color); color: white; padding: 8px; text-align: left; }
        .bio-table td { border-bottom: 1px solid #ddd; padding: 8px; }
        .bio-table tr:nth-child(even) { background-color: #f9f9f9; }

        /* GR√ÅFICO */
        .chart-container { margin-top: 20px; background: white; padding: 10px; border-radius: 8px; border: 1px solid #eee; height: 250px; }

        /* ALARMA */
        #alarm-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(211, 47, 47, 0.95);
            z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; text-align: center; padding: 20px;
            animation: pulse 1s infinite;
        }
        @keyframes pulse { 0% { background-color: rgba(211, 47, 47, 0.9); } 50% { background-color: rgba(183, 28, 28, 1); } 100% { background-color: rgba(211, 47, 47, 0.9); } }
        
        .alarm-box { background: white; color: #333; padding: 20px; border-radius: 10px; width: 80%; max-width: 300px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .alarm-box h2 { color: var(--alarm-color); margin-top: 0; text-transform: uppercase; letter-spacing: 1px; }
        .alarm-data { font-size: 1.1rem; margin: 10px 0; line-height: 1.6; }
        .alarm-btn { background-color: var(--alarm-color); color: white; border: none; padding: 10px 20px; font-size: 1rem; border-radius: 5px; cursor: pointer; margin-top: 15px; width: 100%; font-weight: bold; }
        #login-error { color: #ffcdd2; text-align: center; margin-top: 10px; font-size: 0.9rem; }

    </style>
</head>
<body>

<audio id="alarm-sound" loop>
    <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" type="audio/ogg">
</audio>

<div class="app-container">
    
    <section id="login-screen">
        <h2>Vannamei Data</h2>
        <p style="text-align: center; opacity: 0.9; margin-top: -10px;">Gesti√≥n Productiva</p>
        <form id="login-form">
            <div class="input-group">
                <input type="email" id="email" placeholder="Usuario" required autocomplete="username" value="vannameidata@gmail.com">
            </div>
            <div class="input-group">
                <input type="password" id="password" placeholder="Contrase√±a" required autocomplete="current-password">
                <button type="button" class="toggle-password" id="toggle-pwd-btn">üëÅÔ∏è</button>
            </div>
            <button type="submit" class="primary-btn" id="btn-ingresar">INGRESAR SEGURO</button>
            <div id="login-error" class="hidden"></div>
        </form>
    </section>

    <section id="dashboard-screen" class="hidden">
        <div class="screen-header">
            <button class="back-btn" onclick="navigation.logout()">&#8592;</button>
            <h3>Panel de Control</h3>
        </div>
        <div class="content-area">
            <p>Bienvenido, <span id="user-display" style="font-weight:bold; color:var(--primary-color);">Cargando...</span></p>
            <div class="dashboard-grid">
                <button class="dash-btn" onclick="navigation.showScreen('config-screen'); loadConfig();">Configuraci√≥n de Piscinas</button>
                <button class="dash-btn" onclick="navigation.showScreen('feeding-screen'); loadPoolsForSelect('feed-pool-select');">Registro de Alimentaci√≥n</button>
                <button class="dash-btn" onclick="navigation.showScreen('water-screen'); loadPoolsForSelect('water-pool-select');">Calidad de Agua</button>
                <button class="dash-btn" onclick="navigation.showScreen('bio-screen'); loadPoolsForSelect('bio-pool-select');">Biometr√≠as</button>
                <button class="dash-btn" onclick="navigation.showScreen('status-screen'); loadPoolsForSelect('status-pool-select');">Estatus de Piscinas</button>
                
                <button class="dash-btn" onclick="navigation.showScreen('inputs-screen'); loadPoolsForSelect('inputs-pool-select');">Registro de Insumos</button>
            </div>
        </div>
    </section>

    <section id="config-screen" class="hidden">
        <div class="screen-header">
            <button class="back-btn" onclick="navigation.goBack()">&#8592;</button>
            <h3>Configuraci√≥n</h3>
        </div>
        <div class="content-area">
            <form id="config-form">
                <div class="input-group"><label>Nombre de la Granja</label><input type="text" id="farm-name" placeholder="Ej: Santa Clara" required></div>
                <div class="input-group"><label>Cantidad de Piscinas</label><input type="number" id="pool-count" placeholder="0" min="1" max="50" oninput="renderPoolInputs(this.value)"></div>
                <div style="border-top: 1px solid #eee; margin: 20px 0;"></div>
                <div id="pool-areas-container"></div>
                <button type="button" onclick="saveConfig()" class="primary-btn" style="margin-top: 20px;">GUARDAR</button>
            </form>
        </div>
    </section>

    <section id="feeding-screen" class="hidden">
        <div class="screen-header">
            <button class="back-btn" onclick="navigation.goBack()">&#8592;</button>
            <h3>Alimentaci√≥n</h3>
        </div>
        <div class="content-area">
            <form id="feeding-form">
                <div class="input-group"><label>Fecha</label><input type="date" id="feed-date" required></div>
                <div class="input-group"><label>Piscina</label><select id="feed-pool-select" required><option value="">Cargando...</option></select></div>
                <div class="input-group"><label>Kilos Recargados</label><input type="number" id="feed-recharged" placeholder="0.00" step="0.01"></div>
                <div class="input-group"><label>Kilos Consumidos</label><input type="number" id="feed-consumed" placeholder="0.00" step="0.01" required></div>
                <button type="button" onclick="saveFeeding()" class="primary-btn">GUARDAR</button>
            </form>
        </div>
    </section>

    <section id="water-screen" class="hidden">
        <div class="screen-header">
            <button class="back-btn" onclick="navigation.goBack()">&#8592;</button>
            <h3>Calidad de Agua</h3>
        </div>
        <div class="content-area">
            <form id="water-form">
                <div class="input-group"><label>Fecha</label><input type="date" id="water-date" required></div>
                <div class="input-group"><label>Hora</label><input type="time" id="water-time" required></div>
                <div class="input-group"><label>Piscina</label><select id="water-pool-select" required><option value="">Cargando...</option></select></div>
                
                <div style="background: #e3f2fd; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                    <label style="color:#0277bd;">PAR√ÅMETROS F√çSICOS</label>
                    <div class="input-group">
                        <label>Ox√≠geno (mg/L) <span style="color:red; font-size:0.8em;">*Alarma si &le; 3</span></label>
                        <input type="number" id="water-o2" placeholder="Ej: 4.5" step="0.01" required style="border: 2px solid #0288d1;">
                    </div>
                    <div class="input-group"><label>Disco Secchi (cm)</label><input type="number" id="water-secchi" placeholder="Ej: 35" step="1"></div>
                    <div class="input-group"><label>Temperatura (¬∞C)</label><input type="number" id="water-temp" placeholder="Ej: 27.5" step="0.1"></div>
                    <div class="input-group"><label>pH</label><input type="number" id="water-ph" placeholder="Ej: 7.8" step="0.01"></div>
                    <div class="input-group"><label>Salinidad (ppt)</label><input type="number" id="water-sal" placeholder="Ej: 15" step="0.1"></div>
                </div>

                <div class="chemistry-section">
                    <span class="chemistry-title">PAR√ÅMETROS QU√çMICOS</span>
                    <div class="input-group"><label>TAN (Amonio Total mg/L)</label><input type="number" id="water-tan" step="0.001"></div>
                    <div class="input-group"><label>NO2 (Nitritos mg/L)</label><input type="number" id="water-no2" step="0.001"></div>
                    <div class="input-group"><label>Alcalinidad (mg/L CaCO3)</label><input type="number" id="water-alk" step="1"></div>
                    <div class="input-group"><label>Dureza (mg/L CaCO3)</label><input type="number" id="water-hard" step="1"></div>
                    <div class="input-group"><label>Magnesio</label><input type="number" id="water-mg" step="1"></div>
                    <div class="input-group"><label>Potasio</label><input type="number" id="water-k" step="1"></div>
                    <div class="input-group"><label>Fosfatos (PO4)</label><input type="number" id="water-po4" step="0.01"></div>
                </div>
                <button type="button" onclick="saveWaterQuality()" class="primary-btn" style="margin-top: 15px;">GUARDAR PAR√ÅMETROS</button>
            </form>
        </div>
    </section>

    <section id="bio-screen" class="hidden">
        <div class="screen-header">
            <button class="back-btn" onclick="navigation.goBack()">&#8592;</button>
            <h3>Biometr√≠as</h3>
        </div>
        <div class="content-area">
            <div class="input-group">
                <label>Piscina Activa</label>
                <select id="bio-pool-select" onchange="loadBioData(this.value)">
                    <option value="">Seleccione Piscina...</option>
                </select>
            </div>
            <form id="bio-form" style="background:#fff; padding:15px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.05);">
                <h4 style="margin-top:0; color:var(--primary-color);">A√±adir Registro</h4>
                <div class="input-group">
                    <label>Tipo de Registro</label>
                    <select id="bio-type" required>
                        <option value="Biometr√≠a">Biometr√≠a (Muestreo)</option>
                        <option value="Siembra">Siembra (Inicio Ciclo)</option>
                        <option value="Cosecha">Cosecha (Fin Ciclo)</option>
                    </select>
                </div>
                <div class="input-group"><label>Fecha</label><input type="date" id="bio-date" required></div>
                <div class="dashboard-grid">
                    <div class="input-group"><label>Camarones Vivos (Und)</label><input type="number" id="bio-count" placeholder="Cant." required></div>
                    <div class="input-group"><label>Peso Promedio (g)</label><input type="number" id="bio-weight" placeholder="Gramos" step="0.01" required></div>
                </div>
                <button type="button" onclick="saveBiometry()" class="primary-btn">A√ëADIR REGISTRO</button>
            </form>
            <h4 style="margin-top:30px; margin-bottom:5px;">Gr√°fico de Crecimiento</h4>
            <div class="chart-container"><canvas id="growthChart"></canvas></div>
            <h4 style="margin-top:30px; margin-bottom:5px;">Historial del Ciclo</h4>
            <table class="bio-table">
                <thead><tr><th>Fecha</th><th>Tipo</th><th>Peso(g)</th><th>Bio(Kg)</th><th>Surv(%)</th></tr></thead>
                <tbody id="bio-table-body"><tr><td colspan="5" style="text-align:center;">Seleccione una piscina</td></tr></tbody>
            </table>
        </div>
    </section>

    <section id="status-screen" class="hidden">
        <div class="screen-header">
            <button class="back-btn" onclick="navigation.goBack()">&#8592;</button>
            <h3>Estatus de Piscina</h3>
        </div>
        <div class="content-area">
            <form id="status-form">
                <div class="input-group"><label>Fecha de Registro</label><input type="date" id="status-date" required></div>
                <div class="input-group"><label>Seleccionar Piscina</label><select id="status-pool-select" required><option value="">Cargando...</option></select></div>
                <div class="input-group">
                    <label>Nuevo Estado</label>
                    <select id="status-type" required style="padding: 15px; font-weight: bold; color: var(--primary-color);">
                        <option value="Cosecha">Cosecha</option>
                        <option value="Seca">Seca</option>
                        <option value="Preparado">Preparado</option>
                        <option value="Llenado">Llenado</option>
                        <option value="Siembra">Siembra</option>
                    </select>
                </div>
                <button type="button" onclick="saveStatus()" class="primary-btn" style="margin-top: 20px;">GUARDAR ESTATUS</button>
            </form>
        </div>
    </section>

    <section id="inputs-screen" class="hidden">
        <div class="screen-header">
            <button class="back-btn" onclick="navigation.goBack()">&#8592;</button>
            <h3>Registro de Insumos</h3>
        </div>
        <div class="content-area">
            <form id="inputs-form">
                <div class="input-group">
                    <label>Fecha de Aplicaci√≥n</label>
                    <input type="date" id="input-date" required>
                </div>

                <div class="input-group">
                    <label>Seleccionar Piscina</label>
                    <select id="inputs-pool-select" required><option value="">Cargando...</option></select>
                </div>

                <div class="input-group">
                    <label>Tipo de Insumo</label>
                    <select id="input-type" required>
                        <option value="">-- Seleccione --</option>
                        <option value="Enmienda">Enmienda (Cal, Silicato)</option>
                        <option value="Fertilizante">Fertilizante (Urea, etc)</option>
                        <option value="Probi√≥tico">Probi√≥tico / Biorremediador</option>
                        <option value="Melaza">Melaza / Fuente Carbono</option>
                        <option value="Medicamento">Medicamento / Vitamina</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>Nombre del Producto</label>
                    <input type="text" id="input-product" placeholder="Ej: Cal Agr√≠cola, Sanolife..." required>
                </div>

                <div class="dashboard-grid">
                    <div class="input-group">
                        <label>Cantidad</label>
                        <input type="number" id="input-amount" placeholder="0.00" step="0.01" required>
                    </div>
                    <div class="input-group">
                        <label>Unidad</label>
                        <select id="input-unit">
                            <option value="Kg">Kilogramos (Kg)</option>
                            <option value="Lt">Litros (Lt)</option>
                            <option value="Gr">Gramos (g)</option>
                            <option value="Lb">Libras (Lb)</option>
                            <option value="Sacos">Sacos</option>
                        </select>
                    </div>
                </div>

                <button type="button" onclick="saveInput()" class="primary-btn" style="margin-top: 10px;">GUARDAR INSUMO</button>
            </form>
        </div>
    </section>

    <section id="generic-page" class="hidden">
        <div class="screen-header">
            <button class="back-btn" onclick="navigation.goBack()">&#8592;</button>
            <h3 id="page-title">T√≠tulo</h3>
        </div>
        <div class="content-area"><p>En construcci√≥n...</p></div>
    </section>

</div>

<div id="alarm-overlay" class="hidden">
    <div class="alarm-box">
        <h2>‚ö†Ô∏è ALERTA CR√çTICA ‚ö†Ô∏è</h2>
        <div class="alarm-data">
            <strong id="alarm-pool">Piscina X</strong><br>
            <span id="alarm-date">--/--/--</span> <span id="alarm-time">--:--</span><br>
            <div style="margin:10px 0; font-size:1.4rem; color:#d32f2f;">
                OX√çGENO: <b id="alarm-value">0.0</b> mg/L
            </div>
            Temp: <span id="alarm-temp">--</span>¬∞C
        </div>
        <button class="alarm-btn" onclick="stopAlarm()">ENTENDIDO - APAGAR</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, where, orderBy, getDocs, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBBgvzjBdgvSlHiIqyGL3abcG6fHFS-m6I",
      authDomain: "vannamei--data.firebaseapp.com",
      projectId: "vannamei--data",
      storageBucket: "vannamei--data.firebasestorage.app",
      messagingSenderId: "758235885282",
      appId: "1:758235885282:web:a7ad387667a05a1f7778bb",
      measurementId: "G-MN2YM6T1LE"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Variables Globales
    const SESSION_ID = 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    let growthChartInstance = null;

    // Fechas por defecto
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('feed-date').value = today;
    document.getElementById('water-date').value = today;
    document.getElementById('bio-date').value = today;
    document.getElementById('status-date').value = today;
    document.getElementById('input-date').value = today; // Default Insumos
    document.getElementById('water-time').value = new Date().toTimeString().substring(0,5);

    // --- NAVEGACI√ìN ---
    window.navigation = {
        showScreen: (screenId) => {
            document.querySelectorAll('.app-container > section').forEach(el => el.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
            window.scrollTo(0,0);
        },
        goBack: () => window.navigation.showScreen('dashboard-screen'),
        goToGeneric: (title) => {
            document.getElementById('page-title').innerText = title;
            window.navigation.showScreen('generic-page');
        },
        logout: async () => {
            await signOut(auth);
            document.getElementById('password').value = "";
            window.navigation.showScreen('login-screen');
        }
    };

    // --- LOGIN ---
    document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const pass = document.getElementById('password').value;
        const btn = document.getElementById('btn-ingresar');
        const err = document.getElementById('login-error');
        
        btn.innerText = "Verificando..."; btn.disabled = true; err.classList.add('hidden');
        try {
            const cred = await signInWithEmailAndPassword(auth, email, pass);
            document.getElementById('user-display').innerText = cred.user.email;
            window.navigation.showScreen('dashboard-screen');
            startAlarmListener(); 
        } catch (error) {
            err.innerText = "Error: Credenciales incorrectas."; err.classList.remove('hidden');
        } finally {
            btn.innerText = "INGRESAR SEGURO"; btn.disabled = false;
        }
    });

    // --- HELPERS ---
    window.loadPoolsForSelect = async (selectId) => {
        const select = document.getElementById(selectId);
        if(select.options.length > 2) return; 
        
        select.innerHTML = '<option value="">Cargando...</option>';
        try {
            const snap = await getDoc(doc(db, "config", "general"));
            select.innerHTML = '<option value="">Seleccione Piscina</option>';
            if (snap.exists() && snap.data().pools) {
                snap.data().pools.forEach(pool => {
                    const opt = document.createElement('option');
                    opt.value = pool.id; 
                    opt.text = `Piscina ${pool.id}`;
                    select.appendChild(opt);
                });
            }
        } catch (e) { select.innerHTML = '<option value="">Error carga</option>'; }
    };

    // --- CONFIG ---
    window.renderPoolInputs = (val) => {
        const c = document.getElementById('pool-areas-container'); c.innerHTML = '';
        const count = parseInt(val);
        if(!count) return;
        for(let i=1; i<=count; i++) c.innerHTML += `<div class="pool-input-row"><label>Piscina ${i}</label><input type="number" class="pool-area-input" data-id="${i}" placeholder="Has"></div>`;
    };
    window.saveConfig = async () => {
        if (!auth.currentUser) return;
        const name = document.getElementById('farm-name').value;
        const count = document.getElementById('pool-count').value;
        const inputs = document.querySelectorAll('.pool-area-input');
        let pools = [];
        inputs.forEach(i => pools.push({ id: i.dataset.id, area: parseFloat(i.value)||0 }));
        await setDoc(doc(db, "config", "general"), { farmName: name, poolCount: parseInt(count), pools, updatedBy: auth.currentUser.email });
        alert("Configuraci√≥n guardada"); window.navigation.goBack();
    };
    window.loadConfig = async () => {
         try {
            const snap = await getDoc(doc(db, "config", "general"));
            if (snap.exists()) {
                const data = snap.data();
                document.getElementById('farm-name').value = data.farmName;
                document.getElementById('pool-count').value = data.poolCount;
                renderPoolInputs(data.poolCount);
                const inputs = document.querySelectorAll('.pool-area-input');
                data.pools.forEach((p,i) => { if(inputs[i]) inputs[i].value = p.area; });
            }
        } catch(e){}
    };

    // --- ALIMENTACI√ìN ---
    window.saveFeeding = async () => {
        if (!auth.currentUser) return;
        const date = document.getElementById('feed-date').value;
        const pool = document.getElementById('feed-pool-select').value;
        const rec = document.getElementById('feed-recharged').value;
        const cons = document.getElementById('feed-consumed').value;
        if(!date || !pool) return alert("Faltan datos");
        await addDoc(collection(db, "feeding_records"), { date, poolId: pool, recharged: parseFloat(rec)||0, consumed: parseFloat(cons)||0, user: auth.currentUser.email });
        alert("Alimentaci√≥n registrada"); document.getElementById('feed-consumed').value = "";
    };

    // --- CALIDAD DE AGUA ---
    window.saveWaterQuality = async () => {
        if (!auth.currentUser) return alert("Sesi√≥n finalizada");
        const data = {
            date: document.getElementById('water-date').value,
            time: document.getElementById('water-time').value,
            poolId: document.getElementById('water-pool-select').value,
            oxygen: parseFloat(document.getElementById('water-o2').value) || 0,
            secchi: parseFloat(document.getElementById('water-secchi').value) || 0,
            temp: parseFloat(document.getElementById('water-temp').value) || 0,
            ph: parseFloat(document.getElementById('water-ph').value) || 0,
            salinity: parseFloat(document.getElementById('water-sal').value) || 0,
            tan: parseFloat(document.getElementById('water-tan').value) || 0,
            no2: parseFloat(document.getElementById('water-no2').value) || 0,
            alk: parseFloat(document.getElementById('water-alk').value) || 0,
            hard: parseFloat(document.getElementById('water-hard').value) || 0,
            mg: parseFloat(document.getElementById('water-mg').value) || 0,
            k: parseFloat(document.getElementById('water-k').value) || 0,
            po4: parseFloat(document.getElementById('water-po4').value) || 0,
            user: auth.currentUser.email,
            timestamp: new Date()
        };
        if(!data.date || !data.poolId || !document.getElementById('water-o2').value) return alert("Faltan datos obligatorios (Ox√≠geno)");
        try {
            await addDoc(collection(db, "water_quality"), data);
            if (data.oxygen <= 3.0) {
                await addDoc(collection(db, "active_alarms"), { type: "LOW_OXYGEN", poolId: data.poolId, value: data.oxygen, temp: data.temp, date: data.date, time: data.time, timestamp: new Date(), originSessionId: SESSION_ID });
            }
            alert("Guardado"); window.navigation.goBack();
        } catch (e) { alert("Error: " + e.message); }
    };

    // --- BIOMETR√çAS ---
    window.saveBiometry = async () => {
        if (!auth.currentUser) return;
        const poolId = document.getElementById('bio-pool-select').value;
        const type = document.getElementById('bio-type').value;
        const date = document.getElementById('bio-date').value;
        const count = parseFloat(document.getElementById('bio-count').value);
        const weight = parseFloat(document.getElementById('bio-weight').value);
        if(!poolId || !date || !count || !weight) return alert("Complete todos los campos");
        try {
            await addDoc(collection(db, "biometrics"), { poolId, type, date, count, weight, timestamp: new Date(), user: auth.currentUser.email });
            alert("Registro a√±adido"); loadBioData(poolId);
        } catch(e) { alert("Error: " + e.message); }
    };

    window.loadBioData = async (poolId) => {
        if(!poolId) return;
        const tbody = document.getElementById('bio-table-body');
        tbody.innerHTML = '<tr><td colspan="5">Cargando datos...</td></tr>';
        const q = query(collection(db, "biometrics"), where("poolId", "==", poolId), orderBy("date", "asc"));
        const querySnapshot = await getDocs(q);
        let records = [];
        querySnapshot.forEach(doc => records.push(doc.data()));

        let currentCycleStart = null;
        let cycleRecords = [];
        for (let i = records.length - 1; i >= 0; i--) {
            if (records[i].type === 'Siembra') {
                cycleRecords = records.filter(r => r.date >= records[i].date);
                currentCycleStart = records[i];
                break;
            }
        }
        if (!currentCycleStart && records.length > 0) cycleRecords = records;

        tbody.innerHTML = '';
        let labels = [];
        let dataPoints = [];
        if(cycleRecords.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Sin registros para esta piscina</td></tr>';
        } else {
            cycleRecords.forEach(rec => {
                const biomass = ((rec.count * rec.weight) / 1000).toFixed(2);
                let survival = "--";
                if (currentCycleStart) {
                    const survPct = (rec.count / currentCycleStart.count) * 100;
                    survival = survPct.toFixed(1) + "%";
                }
                const row = `<tr><td>${rec.date.substring(5)}</td><td>${rec.type}</td><td>${rec.weight}</td><td>${biomass}</td><td>${survival}</td></tr>`;
                tbody.innerHTML += row;
                labels.push(rec.date.substring(5));
                dataPoints.push(rec.weight);
            });
        }
        renderChart(labels, dataPoints);
    };

    function renderChart(labels, data) {
        const ctx = document.getElementById('growthChart').getContext('2d');
        if (growthChartInstance) growthChartInstance.destroy();
        growthChartInstance = new Chart(ctx, {
            type: 'line',
            data: { labels: labels, datasets: [{ label: 'Peso Promedio (g)', data: data, borderColor: '#006064', backgroundColor: 'rgba(0, 96, 100, 0.1)', borderWidth: 2, fill: true, tension: 0.3 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: {display:true, text:'Gramos'} } } }
        });
    }

    // --- ESTATUS DE PISCINAS ---
    window.saveStatus = async () => {
        if (!auth.currentUser) return alert("Sesi√≥n expirada");
        const date = document.getElementById('status-date').value;
        const poolId = document.getElementById('status-pool-select').value;
        const status = document.getElementById('status-type').value;
        if (!date || !poolId || !status) return alert("Faltan datos");

        try {
            await addDoc(collection(db, "pool_status"), { date, poolId, status, user: auth.currentUser.email, timestamp: new Date() });
            alert(`Estado actualizado a: ${status}`); window.navigation.goBack();
        } catch (error) { alert("Error: " + error.message); }
    };

    // --- INSUMOS (NUEVO) ---
    window.saveInput = async () => {
        if (!auth.currentUser) return alert("Sesi√≥n expirada");
        
        const date = document.getElementById('input-date').value;
        const poolId = document.getElementById('inputs-pool-select').value;
        const type = document.getElementById('input-type').value;
        const product = document.getElementById('input-product').value;
        const amount = parseFloat(document.getElementById('input-amount').value);
        const unit = document.getElementById('input-unit').value;

        if(!date || !poolId || !type || !product || !amount) return alert("Por favor complete todos los campos.");

        const btn = document.querySelector('#inputs-screen button.primary-btn');
        btn.innerText = "Guardando..."; btn.disabled = true;

        try {
            await addDoc(collection(db, "inputs_registry"), {
                date, poolId, type, product, amount, unit,
                user: auth.currentUser.email,
                timestamp: new Date()
            });
            alert("Insumo registrado correctamente.");
            // Limpiar campos de cantidad/producto para agilizar
            document.getElementById('input-amount').value = "";
            document.getElementById('input-product').value = "";
        } catch(e) { alert("Error: " + e.message); }
        finally { btn.innerText = "GUARDAR INSUMO"; btn.disabled = false; }
    };

    // --- ALARMA ---
    let unsubscribeAlarm = null;
    function startAlarmListener() {
        if(unsubscribeAlarm) return;
        const q = query(collection(db, "active_alarms"), orderBy("timestamp", "desc"), limit(1));
        unsubscribeAlarm = onSnapshot(q, (snapshot) => {
            snapshot.docChanges().forEach((change) => {
                if (change.type === "added") {
                    const alarm = change.doc.data();
                    if (((new Date() - alarm.timestamp.toDate()) / 1000) > 60) return;
                    if (alarm.originSessionId === SESSION_ID) return;
                    triggerVisualAlarm(alarm);
                }
            });
        });
    }

    function triggerVisualAlarm(data) {
        document.getElementById('alarm-pool').innerText = "PISCINA " + data.poolId;
        document.getElementById('alarm-date').innerText = data.date;
        document.getElementById('alarm-time').innerText = data.time;
        document.getElementById('alarm-value').innerText = data.value;
        document.getElementById('alarm-temp').innerText = data.temp;
        document.getElementById('alarm-overlay').classList.remove('hidden');
        const audio = document.getElementById('alarm-sound');
        audio.currentTime = 0; audio.play().catch(e=>{});
        if(navigator.vibrate) navigator.vibrate([500, 200, 500]);
    }

    window.stopAlarm = () => {
        document.getElementById('alarm-overlay').classList.add('hidden');
        document.getElementById('alarm-sound').pause();
    };

    document.getElementById('toggle-pwd-btn').addEventListener('click', () => {
        const i = document.getElementById('password'); i.type = i.type === 'password' ? 'text' : 'password';
    });

</script>
</body>
</html>

