<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vannamei Data - Gesti√≥n Integral</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* --- ESTILOS GENERALES --- */
        :root { --primary: #006064; --secondary: #0097a7; --bg: #f4f6f8; --text: #333; --white: #ffffff; --accent: #ff6f00; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg); margin: 0; padding: 0; color: var(--text); font-size: 14px; }
        
        .app-container { max-width: 480px; margin: 0 auto; background: var(--white); min-height: 100vh; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .hidden { display: none !important; }

        /* HEADER & NAV */
        .screen-header { background: var(--primary); color: white; padding: 15px; display: flex; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .back-btn { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; margin-right: 15px; }
        .content-area { padding: 15px; flex: 1; overflow-y: auto; padding-bottom: 80px; }

        /* INPUTS & FORMS */
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: var(--primary); font-size: 0.9rem; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; }
        input:focus, select:focus { outline: 2px solid var(--secondary); border-color: transparent; }
        
        /* BOTONES */
        button.primary-btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .dash-btn { background: white; border: 1px solid #ddd; border-radius: 10px; padding: 15px; text-align: center; color: var(--primary); font-weight: 600; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; }
        .dash-btn:active { transform: scale(0.98); background: #e0f7fa; }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        /* --- REPORTES ESPEC√çFICOS --- */
        .report-tabs { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 15px; border-bottom: 1px solid #eee; }
        .tab-btn { white-space: nowrap; padding: 8px 12px; border: 1px solid var(--primary); border-radius: 20px; background: none; color: var(--primary); font-size: 0.85rem; cursor: pointer; }
        .tab-btn.active { background: var(--primary); color: white; }
        
        .filter-box { background: #f5f5f5; padding: 10px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #eee; }
        .data-card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 15px; }
        .kpi-row { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .kpi-box { text-align: center; flex: 1; border-right: 1px solid #eee; }
        .kpi-box:last-child { border: none; }
        .kpi-num { display: block; font-size: 1.2rem; font-weight: bold; color: var(--secondary); }
        .kpi-txt { font-size: 0.75rem; color: #666; text-transform: uppercase; }

        table.mini-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; margin-top: 10px; }
        table.mini-table th { text-align: left; border-bottom: 2px solid #ddd; padding: 5px; color: var(--primary); }
        table.mini-table td { border-bottom: 1px solid #eee; padding: 6px 5px; }
        
        .status-badge { padding: 3px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; color: white; }
        .st-sembrada { background: #2e7d32; }
        .st-seca { background: #d32f2f; }
        .st-prep { background: #f9a825; }

        /* Login Styles */
        #login-screen { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; justify-content: center; }
        .login-box { text-align: center; }
        .toggle-pwd { position: absolute; right: 10px; top: 35px; background: none; border: none; cursor: pointer; }
    </style>
</head>
<body>

<div class="app-container">
    
    <section id="login-screen" style="display: flex;">
        <div class="login-box" style="width: 80%;">
            <h2>Vannamei Data</h2>
            <p>Sistema de Gesti√≥n Acu√≠cola</p>
            <form id="login-form">
                <div class="input-group">
                    <input type="email" id="email" placeholder="Usuario" value="vannameidata@gmail.com">
                </div>
                <div class="input-group" style="position:relative;">
                    <input type="password" id="password" placeholder="Contrase√±a">
                    <button type="button" class="toggle-pwd" onclick="togglePass()">üëÅÔ∏è</button>
                </div>
                <button type="submit" class="primary-btn" id="btn-login">INGRESAR</button>
                <div id="login-error" style="color: #ffcdd2; margin-top: 10px; display: none;">Error de credenciales</div>
            </form>
        </div>
    </section>

    <section id="dashboard-screen" class="hidden">
        <div class="screen-header">
            <button class="back-btn" onclick="logout()">&#8592;</button>
            <h3>Panel de Control</h3>
        </div>
        <div class="content-area">
            <p>Bienvenido, <b id="user-display">Usuario</b></p>
            <div class="dashboard-grid">
                <button class="dash-btn" onclick="nav('config-screen'); loadConfig();">Configuraci√≥n</button>
                <button class="dash-btn" onclick="nav('feeding-screen'); loadPools('feed-pool');">Alimentaci√≥n</button>
                <button class="dash-btn" onclick="nav('water-screen'); loadPools('water-pool');">Calidad Agua</button>
                <button class="dash-btn" onclick="nav('bio-screen'); loadPools('bio-pool');">Biometr√≠as</button>
                <button class="dash-btn" onclick="nav('inputs-screen'); loadPools('input-pool');">Insumos</button>
                <button class="dash-btn" onclick="nav('status-screen'); loadPools('status-pool');">Estatus</button>
                <button class="dash-btn" style="grid-column: span 2; background:#e0f7fa;" onclick="nav('reports-screen'); initReports();">üìä CENTRO DE REPORTES</button>
            </div>
        </div>
    </section>

    <section id="config-screen" class="hidden">
        <div class="screen-header"><button class="back-btn" onclick="goBack()">&#8592;</button><h3>Configuraci√≥n</h3></div>
        <div class="content-area">
            <div class="input-group"><label>Granja</label><input id="cfg-name" placeholder="Nombre"></div>
            <div class="input-group"><label>N¬∞ Piscinas</label><input type="number" id="cfg-count" oninput="renderPools(this.value)"></div>
            <div id="cfg-pools"></div>
            <button class="primary-btn" onclick="saveConfig()">GUARDAR</button>
        </div>
    </section>

    <section id="feeding-screen" class="hidden">
        <div class="screen-header"><button class="back-btn" onclick="goBack()">&#8592;</button><h3>Alimentaci√≥n</h3></div>
        <div class="content-area">
            <div class="input-group"><label>Fecha</label><input type="date" id="feed-date"></div>
            <div class="input-group"><label>Piscina</label><select id="feed-pool"></select></div>
            <div class="input-group"><label>Kilos Recargados</label><input type="number" id="feed-rec" placeholder="0.0"></div>
            <div class="input-group"><label>Kilos Consumidos</label><input type="number" id="feed-cons" placeholder="0.0"></div>
            <button class="primary-btn" onclick="saveFeed()">GUARDAR</button>
        </div>
    </section>

    <section id="water-screen" class="hidden">
        <div class="screen-header"><button class="back-btn" onclick="goBack()">&#8592;</button><h3>Calidad de Agua</h3></div>
        <div class="content-area">
            <div class="input-group"><label>Fecha</label><input type="date" id="water-date"></div>
            <div class="input-group"><label>Hora</label><input type="time" id="water-time"></div>
            <div class="input-group"><label>Piscina</label><select id="water-pool"></select></div>
            <div class="filter-box">
                <label>F√≠sicos (Alarma O2 &le; 3)</label>
                <input type="number" id="w-o2" placeholder="Ox√≠geno (mg/L)" style="margin-bottom:5px;">
                <input type="number" id="w-ph" placeholder="pH" style="margin-bottom:5px;">
                <input type="number" id="w-temp" placeholder="Temp (¬∞C)" style="margin-bottom:5px;">
                <input type="number" id="w-sal" placeholder="Salinidad (ppt)">
                <input type="number" id="w-secchi" placeholder="Disco Secchi (cm)" style="margin-top:5px;">
            </div>
            <div class="filter-box">
                <label>Qu√≠micos</label>
                <input type="number" id="w-tan" placeholder="TAN (Amonio)" style="margin-bottom:5px;">
                <input type="number" id="w-no2" placeholder="Nitritos">
            </div>
            <button class="primary-btn" onclick="saveWater()">GUARDAR</button>
        </div>
    </section>

    <section id="bio-screen" class="hidden">
        <div class="screen-header"><button class="back-btn" onclick="goBack()">&#8592;</button><h3>Biometr√≠as</h3></div>
        <div class="content-area">
            <div class="input-group"><label>Piscina</label><select id="bio-pool"></select></div>
            <div class="input-group"><label>Tipo</label><select id="bio-type"><option>Biometr√≠a</option><option>Siembra</option><option>Cosecha</option></select></div>
            <div class="input-group"><label>Fecha</label><input type="date" id="bio-date"></div>
            <div class="input-group"><label>Camarones Vivos</label><input type="number" id="bio-count"></div>
            <div class="input-group"><label>Peso Promedio (g)</label><input type="number" id="bio-weight"></div>
            <button class="primary-btn" onclick="saveBio()">GUARDAR</button>
        </div>
    </section>

    <section id="status-screen" class="hidden">
        <div class="screen-header"><button class="back-btn" onclick="goBack()">&#8592;</button><h3>Estatus</h3></div>
        <div class="content-area">
            <div class="input-group"><label>Fecha</label><input type="date" id="st-date"></div>
            <div class="input-group"><label>Piscina</label><select id="status-pool"></select></div>
            <div class="input-group"><label>Nuevo Estado</label>
                <select id="st-val">
                    <option>Siembra</option><option>Preparado</option><option>Llenado</option><option>Seca</option><option>Cosecha</option>
                </select>
            </div>
            <button class="primary-btn" onclick="saveStatus()">ACTUALIZAR</button>
        </div>
    </section>

    <section id="inputs-screen" class="hidden">
        <div class="screen-header"><button class="back-btn" onclick="goBack()">&#8592;</button><h3>Insumos</h3></div>
        <div class="content-area">
            <div class="input-group"><label>Fecha</label><input type="date" id="in-date"></div>
            <div class="input-group"><label>Piscina</label><select id="input-pool"></select></div>
            <div class="input-group"><label>Producto</label><input id="in-prod" placeholder="Ej: Cal, Melaza"></div>
            <div class="input-group"><label>Cantidad</label><input type="number" id="in-qty"></div>
            <button class="primary-btn" onclick="saveInput()">REGISTRAR</button>
        </div>
    </section>

    <section id="reports-screen" class="hidden">
        <div class="screen-header"><button class="back-btn" onclick="goBack()">&#8592;</button><h3>Reportes</h3></div>
        <div class="content-area">
            
            <div class="report-tabs">
                <button class="tab-btn active" onclick="switchTab('tab-general')">General</button>
                <button class="tab-btn" onclick="switchTab('tab-alim')">Alimentaci√≥n</button>
                <button class="tab-btn" onclick="switchTab('tab-agua')">Calidad Agua</button>
                <button class="tab-btn" onclick="switchTab('tab-bio')">Biometr√≠as</button>
            </div>

            <div id="tab-general" class="report-view">
                <div class="data-card">
                    <h4>Resumen Actual</h4>
                    <div class="kpi-row">
                        <div class="kpi-box"><span class="kpi-num" id="dash-total-bio">--</span><span class="kpi-txt">Biomasa (Kg)</span></div>
                        <div class="kpi-box"><span class="kpi-num" id="dash-active-pools">--</span><span class="kpi-txt">Piscinas Activas</span></div>
                    </div>
                </div>
                <div class="data-card">
                    <h4>Estatus por Piscina</h4>
                    <table class="mini-table">
                        <thead><tr><th>Piscina</th><th>Estado</th><th>D√≠as</th></tr></thead>
                        <tbody id="dash-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="tab-alim" class="report-view hidden">
                <div class="filter-box">
                    <div class="input-group">
                        <label>Rango de Fechas</label>
                        <div style="display:flex; gap:5px;">
                            <input type="date" id="rep-start" onchange="runFeedReport()">
                            <input type="date" id="rep-end" onchange="runFeedReport()">
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Filtrar Piscina</label>
                        <select id="rep-pool-feed" onchange="runFeedReport()"><option value="all">Todas</option></select>
                    </div>
                </div>
                <div class="data-card">
                    <canvas id="feedChart" height="200"></canvas>
                </div>
                <div class="data-card">
                    <h4>Totales del Periodo</h4>
                    <table class="mini-table">
                        <thead><tr><th>Piscina</th><th>Consumido (Kg)</th><th>Recargado (Kg)</th></tr></thead>
                        <tbody id="feed-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="tab-agua" class="report-view hidden">
                <div class="filter-box">
                    <label>Piscina</label>
                    <select id="rep-pool-water" onchange="runWaterReport()"></select>
                    <label style="margin-top:10px;">Par√°metro</label>
                    <select id="rep-param-water" onchange="runWaterReport()">
                        <option value="oxygen">Ox√≠geno</option>
                        <option value="ph">pH</option>
                        <option value="temp">Temperatura</option>
                        <option value="salinity">Salinidad</option>
                    </select>
                </div>
                <div class="data-card">
                    <canvas id="waterChart" height="200"></canvas>
                </div>
            </div>

            <div id="tab-bio" class="report-view hidden">
                <div class="filter-box">
                    <label>Seleccionar Piscina</label>
                    <select id="rep-pool-bio" onchange="runBioReport()"></select>
                </div>
                <div class="kpi-container">
                    <div class="kpi-card"><span class="kpi-value" id="bio-fca">--</span><span class="kpi-label">FCA</span></div>
                    <div class="kpi-card"><span class="kpi-value" id="bio-surv">--%</span><span class="kpi-label">Superv.</span></div>
                </div>
                <div class="data-card">
                    <canvas id="bioChart" height="200"></canvas>
                </div>
            </div>

        </div>
    </section>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, where, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBBgvzjBdgvSlHiIqyGL3abcG6fHFS-m6I",
      authDomain: "vannamei--data.firebaseapp.com",
      projectId: "vannamei--data",
      storageBucket: "vannamei--data.firebasestorage.app",
      messagingSenderId: "758235885282",
      appId: "1:758235885282:web:a7ad387667a05a1f7778bb"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    let myChart = null; // Variable global para gr√°ficos

    // --- UTILS ---
    window.togglePass = () => { const x = document.getElementById("password"); x.type = x.type === "password" ? "text" : "password"; };
    window.nav = (screen) => {
        document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
        document.getElementById(screen).classList.remove('hidden');
        if(screen === 'reports-screen') initReports(); // Cargar dashboard al entrar
    };
    window.goBack = () => nav('dashboard-screen');
    window.logout = () => { auth.signOut(); nav('login-screen'); };
    
    // Fechas por defecto hoy
    const today = new Date().toISOString().split('T')[0];
    ['feed-date','water-date','bio-date','st-date','in-date'].forEach(id => {
        const el = document.getElementById(id); if(el) el.value = today;
    });

    // --- LOGIN ---
    document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
            await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value);
            document.getElementById('user-display').innerText = auth.currentUser.email;
            nav('dashboard-screen');
        } catch(err) { document.getElementById('login-error').style.display='block'; }
    });

    // --- CARGA DE PISCINAS (Gen√©rica) ---
    window.loadPools = async (elemId) => {
        const sel = document.getElementById(elemId);
        if(sel.options.length > 1 && elemId !== 'rep-pool-feed') return; // Cache simple
        sel.innerHTML = '<option value="">Cargando...</option>';
        try {
            const docSnap = await getDoc(doc(db, "config", "general"));
            sel.innerHTML = elemId === 'rep-pool-feed' ? '<option value="all">Todas las Piscinas</option>' : '<option value="">Seleccione...</option>';
            if(docSnap.exists()){
                docSnap.data().pools.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id; opt.text = "Piscina " + p.id;
                    sel.appendChild(opt);
                });
                // Llenar selectores de reporte tambi√©n
                if(elemId === 'feed-pool') loadPools('rep-pool-feed'); // Truco para precargar reportes
                if(elemId === 'water-pool') loadPools('rep-pool-water');
                if(elemId === 'bio-pool') loadPools('rep-pool-bio');
            }
        } catch(e){}
    };

    // --- GUARDADOS SIMPLES ---
    window.renderPools = (n) => {
        const c = document.getElementById('cfg-pools'); c.innerHTML='';
        for(let i=1;i<=n;i++) c.innerHTML+=`<div class="input-group"><label>Piscina ${i} (Has)</label><input class="pool-sz" data-id="${i}" type="number"></div>`;
    };
    window.saveConfig = async () => {
        const pools = Array.from(document.querySelectorAll('.pool-sz')).map(i=>({id:i.dataset.id, area:i.value}));
        await setDoc(doc(db,"config","general"), {name: document.getElementById('cfg-name').value, pools});
        alert("Configurado"); goBack();
    };
    
    // Funciones de guardado (Alimentaci√≥n, Agua, Bio, Estatus, Insumos)
    // Se mantienen igual que la versi√≥n anterior, solo simplificadas visualmente en el HTML
    window.saveFeed = async () => {
        await addDoc(collection(db,"feed"), {
            date: document.getElementById('feed-date').value,
            pool: document.getElementById('feed-pool').value,
            rec: Number(document.getElementById('feed-rec').value),
            cons: Number(document.getElementById('feed-cons').value)
        }); alert("Guardado"); goBack();
    };
    window.saveWater = async () => {
        await addDoc(collection(db,"water"), {
            date: document.getElementById('water-date').value,
            pool: document.getElementById('water-pool').value,
            o2: Number(document.getElementById('w-o2').value),
            ph: Number(document.getElementById('w-ph').value),
            temp: Number(document.getElementById('w-temp').value)
        }); alert("Guardado"); goBack();
    };
    window.saveBio = async () => {
        await addDoc(collection(db,"bio"), {
            date: document.getElementById('bio-date').value,
            pool: document.getElementById('bio-pool').value,
            type: document.getElementById('bio-type').value,
            count: Number(document.getElementById('bio-count').value),
            weight: Number(document.getElementById('bio-weight').value)
        }); alert("Guardado"); goBack();
    };
    window.saveStatus = async () => {
        await addDoc(collection(db,"status"), {
            date: document.getElementById('st-date').value,
            pool: document.getElementById('status-pool').value,
            status: document.getElementById('st-val').value,
            timestamp: new Date() // Para ordenar el √∫ltimo
        }); alert("Estatus Actualizado"); goBack();
    };
    window.saveInput = async () => {
        await addDoc(collection(db,"inputs"), {
            date: document.getElementById('in-date').value,
            pool: document.getElementById('input-pool').value,
            prod: document.getElementById('in-prod').value,
            qty: Number(document.getElementById('in-qty').value)
        }); alert("Insumo Registrado"); goBack();
    };

    // --- L√ìGICA DE REPORTES (EL CEREBRO NUEVO) ---
    
    window.switchTab = (tabId) => {
        document.querySelectorAll('.report-view').forEach(v => v.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.remove('hidden');
        event.target.classList.add('active');
        
        // Ejecutar carga inicial de esa pesta√±a
        if(tabId === 'tab-general') initReports();
        // Las otras esperan a que el usuario filtre
    };

    // 1. DASHBOARD GENERAL
    window.initReports = async () => {
        const tbody = document.getElementById('dash-table-body');
        tbody.innerHTML = '<tr><td colspan="3">Analizando datos...</td></tr>';
        
        // Obtener √∫ltimo estatus de cada piscina
        // Esto requiere una query inteligente. Por simplicidad, traemos los ultimos 50 cambios de estatus y filtramos en JS.
        const qStat = query(collection(db, "status"), orderBy("timestamp", "desc"), limit(100));
        const snap = await getDocs(qStat);
        
        let poolStatusMap = {};
        snap.forEach(doc => {
            const d = doc.data();
            if(!poolStatusMap[d.pool]) poolStatusMap[d.pool] = d;
        });

        // Renderizar tabla
        tbody.innerHTML = '';
        let activeCount = 0;
        
        // Obtener lista de piscinas configuradas
        const cfg = await getDoc(doc(db, "config", "general"));
        if(cfg.exists()){
            const pools = cfg.data().pools;
            pools.forEach(p => {
                const st = poolStatusMap[p.id] ? poolStatusMap[p.id].status : 'Sin datos';
                const date = poolStatusMap[p.id] ? poolStatusMap[p.id].date : '-';
                
                let badgeClass = '';
                if(st === 'Siembra') { badgeClass = 'st-sembrada'; activeCount++; }
                if(st === 'Seca') badgeClass = 'st-seca';
                
                const row = `<tr>
                    <td>Piscina ${p.id}</td>
                    <td><span class="status-badge ${badgeClass}">${st}</span></td>
                    <td>${date}</td>
                </tr>`;
                tbody.innerHTML += row;
            });
            document.getElementById('dash-active-pools').innerText = activeCount;
        }
    };

    // 2. REPORTE DE ALIMENTACI√ìN
    window.runFeedReport = async () => {
        const start = document.getElementById('rep-start').value;
        const end = document.getElementById('rep-end').value;
        const pool = document.getElementById('rep-pool-feed').value;
        
        if(!start || !end) return;

        let q = query(collection(db, "feed"), where("date", ">=", start), where("date", "<=", end));
        if(pool !== 'all') {
            q = query(collection(db, "feed"), where("pool", "==", pool), where("date", ">=", start), where("date", "<=", end));
        }

        const snap = await getDocs(q);
        let dataMap = {}; // Fecha -> Consumo
        let poolTotals = {}; // Piscina -> Total

        snap.forEach(doc => {
            const d = doc.data();
            // Agrupar para gr√°fico (por fecha)
            if(!dataMap[d.date]) dataMap[d.date] = 0;
            dataMap[d.date] += d.cons;

            // Agrupar para tabla (por piscina)
            if(!poolTotals[d.pool]) poolTotals[d.pool] = {cons:0, rec:0};
            poolTotals[d.pool].cons += d.cons;
            poolTotals[d.pool].rec += d.rec;
        });

        // Dibujar Gr√°fico
        const labels = Object.keys(dataMap).sort();
        const values = labels.map(k => dataMap[k]);
        drawChart('feedChart', 'bar', labels, values, 'Kilos Consumidos', '#ff6f00');

        // Llenar Tabla
        const tb = document.getElementById('feed-table-body');
        tb.innerHTML = '';
        Object.keys(poolTotals).forEach(p => {
            tb.innerHTML += `<tr><td>Piscina ${p}</td><td>${poolTotals[p].cons}</td><td>${poolTotals[p].rec}</td></tr>`;
        });
    };

    // 3. REPORTE AGUA (Tendencia)
    window.runWaterReport = async () => {
        const pool = document.getElementById('rep-pool-water').value;
        const param = document.getElementById('rep-param-water').value;
        if(!pool) return;

        const q = query(collection(db, "water"), where("pool", "==", pool), orderBy("date", "asc"));
        const snap = await getDocs(q);
        
        let labels = [];
        let values = [];
        
        snap.forEach(doc => {
            const d = doc.data();
            if(d[param]) {
                labels.push(d.date);
                values.push(d[param]);
            }
        });

        drawChart('waterChart', 'line', labels, values, param.toUpperCase(), '#0288d1');
    };

    // 4. REPORTE BIO (El que ya ten√≠amos)
    window.runBioReport = async () => {
        const pool = document.getElementById('rep-pool-bio').value;
        if(!pool) return;
        
        const q = query(collection(db, "bio"), where("pool", "==", pool), orderBy("date", "asc"));
        const snap = await getDocs(q);
        let labels = [];
        let weights = [];
        let lastBio = null;
        let startBio = null;

        snap.forEach(doc => {
            const d = doc.data();
            labels.push(d.date);
            weights.push(d.weight);
            if(d.type === 'Siembra') startBio = d;
            lastBio = d;
        });

        drawChart('bioChart', 'line', labels, weights, 'Peso (g)', '#2e7d32');

        // Calcular KPI simples
        if(startBio && lastBio) {
            const surv = ((lastBio.count / startBio.count) * 100).toFixed(1);
            document.getElementById('bio-surv').innerText = surv + "%";
        }
    };

    // --- FUNCI√ìN GR√ÅFICA GEN√âRICA ---
    function drawChart(canvasId, type, labels, data, label, color) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        if(myChart) { 
            // Si el gr√°fico es del mismo canvas, destruir. Si es otro, cuidado.
            // Para simplicidad en este ejemplo de 1 archivo, destruimos el anterior global.
            // En producci√≥n idealmente cada canvas tiene su instancia.
            // Aqu√≠ forzamos reset del canvas
        }
        
        // Destruir instancia previa asociada a ESTE canvas si existe
        let existingChart = Chart.getChart(canvasId);
        if (existingChart) existingChart.destroy();

        new Chart(ctx, {
            type: type,
            data: {
                labels: labels,
                datasets: [{
                    label: label,
                    data: data,
                    backgroundColor: color,
                    borderColor: color,
                    borderWidth: 2,
                    tension: 0.3
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

</script>
</body>
</html>

