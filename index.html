<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vannamei Data - Gesti√≥n Acu√≠cola</title>
    <style>
        /* --- ESTILOS (CSS) --- */
        :root { --primary-color: #006064; --secondary-color: #0097a7; --bg-color: #f4f6f8; --text-color: #333; --white: #ffffff; --alarm-color: #d32f2f; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-color); margin: 0; padding: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; color: var(--text-color); }
        .app-container { width: 100%; max-width: 480px; background: var(--white); min-height: 100vh; box-shadow: 0 0 20px rgba(0,0,0,0.1); position: relative; display: flex; flex-direction: column; }
        .hidden { display: none !important; }
        
        /* Login */
        #login-screen { flex: 1; display: flex; flex-direction: column; justify-content: center; padding: 2rem; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; }
        h1, h2, h3 { text-align: center; margin-bottom: 1rem; }
        .input-group { position: relative; margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; box-sizing: border-box; background: #fff; }
        input:focus, select:focus { outline: 2px solid var(--secondary-color); border-color: transparent; }
        
        button.primary-btn { width: 100%; padding: 14px; background-color: var(--primary-color); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        button:disabled { opacity: 0.7; cursor: not-allowed; }
        
        .toggle-password { position: absolute; right: 10px; top: 38px; cursor: pointer; background: none; border: none; color: #666; }
        #login-screen .toggle-password { top: 50%; transform: translateY(-50%); color: #ddd; }
        
        /* Headers */
        .screen-header { background-color: var(--primary-color); color: white; padding: 1rem; display: flex; align-items: center; position: sticky; top: 0; z-index: 10; }
        .back-btn { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; margin-right: 1rem; padding: 0 10px; }
        .content-area { padding: 1.5rem; flex: 1; overflow-y: auto; padding-bottom: 4rem; }
        
        /* Dashboard Grid */
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .dash-btn { background-color: var(--white); border: 1px solid #ddd; border-radius: 12px; padding: 1.5rem 1rem; text-align: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.05); color: var(--primary-color); font-weight: 600; display: flex; align-items: center; justify-content: center; }
        
        /* Config & Forms */
        .pool-input-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; background: #f9f9f9; padding: 8px; border-radius: 6px; }
        .pool-input-row label { margin: 0; font-weight: normal; }
        .pool-input-row input { width: 80px; text-align: center; }
        
        /* Secci√≥n Qu√≠mica (Acorde√≥n visual) */
        .chemistry-section { border: 1px solid #e0e0e0; border-radius: 8px; padding: 10px; margin-top: 15px; background-color: #fafafa; }
        .chemistry-title { font-weight: bold; color: var(--primary-color); margin-bottom: 10px; display: block; border-bottom: 1px solid #ddd; padding-bottom: 5px; }

        #login-error { color: #ffcdd2; text-align: center; margin-top: 10px; font-size: 0.9rem; }

        /* --- ESTILOS DE LA ALARMA --- */
        #alarm-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(211, 47, 47, 0.95); /* Rojo fuerte */
            z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; text-align: center; padding: 20px;
            animation: pulse 1s infinite;
        }
        @keyframes pulse { 0% { background-color: rgba(211, 47, 47, 0.9); } 50% { background-color: rgba(183, 28, 28, 1); } 100% { background-color: rgba(211, 47, 47, 0.9); } }
        
        .alarm-box { background: white; color: #333; padding: 20px; border-radius: 10px; width: 80%; max-width: 300px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .alarm-box h2 { color: var(--alarm-color); margin-top: 0; text-transform: uppercase; letter-spacing: 1px; }
        .alarm-data { font-size: 1.1rem; margin: 10px 0; line-height: 1.6; }
        .alarm-btn { background-color: var(--alarm-color); color: white; border: none; padding: 10px 20px; font-size: 1rem; border-radius: 5px; cursor: pointer; margin-top: 15px; width: 100%; font-weight: bold; }

    </style>
</head>
<body>

<audio id="alarm-sound" loop>
    <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" type="audio/ogg">
</audio>

<div class="app-container">
    
    <section id="login-screen">
        <h2>Vannamei Data</h2>
        <p style="text-align: center; opacity: 0.9; margin-top: -10px;">Gesti√≥n Productiva</p>
        <form id="login-form">
            <div class="input-group">
                <input type="email" id="email" placeholder="Usuario" required autocomplete="username" value="vannameidata@gmail.com">
            </div>
            <div class="input-group">
                <input type="password" id="password" placeholder="Contrase√±a" required autocomplete="current-password">
                <button type="button" class="toggle-password" id="toggle-pwd-btn">üëÅÔ∏è</button>
            </div>
            <button type="submit" class="primary-btn" id="btn-ingresar">INGRESAR SEGURO</button>
            <div id="login-error" class="hidden"></div>
        </form>
    </section>

    <section id="dashboard-screen" class="hidden">
        <div class="screen-header">
            <button class="back-btn" onclick="navigation.logout()">&#8592;</button>
            <h3>Panel de Control</h3>
        </div>
        <div class="content-area">
            <p>Bienvenido, <span id="user-display" style="font-weight:bold; color:var(--primary-color);">Cargando...</span></p>
            <div class="dashboard-grid">
                <button class="dash-btn" onclick="navigation.showScreen('config-screen'); loadConfig();">Configuraci√≥n de Piscinas</button>
                <button class="dash-btn" onclick="navigation.showScreen('feeding-screen'); loadPoolsForSelect('feed-pool-select');">Registro de Alimentaci√≥n</button>
                <button class="dash-btn" onclick="navigation.showScreen('water-screen'); loadPoolsForSelect('water-pool-select');">Calidad de Agua</button>
                
                <button class="dash-btn" onclick="navigation.goToGeneric('Biometr√≠as')">Biometr√≠as</button>
                <button class="dash-btn" onclick="navigation.goToGeneric('Estatus de Piscinas')">Estatus de Piscinas</button>
            </div>
        </div>
    </section>

    <section id="config-screen" class="hidden">
        <div class="screen-header">
            <button class="back-btn" onclick="navigation.goBack()">&#8592;</button>
            <h3>Configuraci√≥n</h3>
        </div>
        <div class="content-area">
            <form id="config-form">
                <div class="input-group">
                    <label>Nombre de la Granja</label>
                    <input type="text" id="farm-name" placeholder="Ej: Santa Clara" required>
                </div>
                <div class="input-group">
                    <label>Cantidad de Piscinas</label>
                    <input type="number" id="pool-count" placeholder="0" min="1" max="50" oninput="renderPoolInputs(this.value)">
                </div>
                <div style="border-top: 1px solid #eee; margin: 20px 0;"></div>
                <div id="pool-areas-container"></div>
                <button type="button" onclick="saveConfig()" class="primary-btn" style="margin-top: 20px;">GUARDAR</button>
            </form>
        </div>
    </section>

    <section id="feeding-screen" class="hidden">
        <div class="screen-header">
            <button class="back-btn" onclick="navigation.goBack()">&#8592;</button>
            <h3>Alimentaci√≥n</h3>
        </div>
        <div class="content-area">
            <form id="feeding-form">
                <div class="input-group"><label>Fecha</label><input type="date" id="feed-date" required></div>
                <div class="input-group"><label>Piscina</label><select id="feed-pool-select" required><option value="">Cargando...</option></select></div>
                <div class="input-group"><label>Kilos Recargados</label><input type="number" id="feed-recharged" placeholder="0.00" step="0.01"></div>
                <div class="input-group"><label>Kilos Consumidos</label><input type="number" id="feed-consumed" placeholder="0.00" step="0.01" required></div>
                <button type="button" onclick="saveFeeding()" class="primary-btn">GUARDAR</button>
            </form>
        </div>
    </section>

    <section id="water-screen" class="hidden">
        <div class="screen-header">
            <button class="back-btn" onclick="navigation.goBack()">&#8592;</button>
            <h3>Calidad de Agua</h3>
        </div>
        <div class="content-area">
            <form id="water-form">
                <div class="input-group"><label>Fecha</label><input type="date" id="water-date" required></div>
                <div class="input-group"><label>Hora</label><input type="time" id="water-time" required></div>
                <div class="input-group"><label>Piscina</label><select id="water-pool-select" required><option value="">Cargando...</option></select></div>
                
                <div style="background: #e3f2fd; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                    <label style="color:#0277bd;">PAR√ÅMETROS F√çSICOS</label>
                    <div class="input-group">
                        <label>Ox√≠geno (mg/L) <span style="color:red; font-size:0.8em;">*Alarma si &le; 3</span></label>
                        <input type="number" id="water-o2" placeholder="Ej: 4.5" step="0.01" required style="border: 2px solid #0288d1;">
                    </div>
                    <div class="input-group"><label>Temperatura (¬∞C)</label><input type="number" id="water-temp" placeholder="Ej: 27.5" step="0.1"></div>
                    <div class="input-group"><label>pH</label><input type="number" id="water-ph" placeholder="Ej: 7.8" step="0.01"></div>
                    <div class="input-group"><label>Salinidad (ppt)</label><input type="number" id="water-sal" placeholder="Ej: 15" step="0.1"></div>
                </div>

                <div class="chemistry-section">
                    <span class="chemistry-title">PAR√ÅMETROS QU√çMICOS</span>
                    <div class="input-group"><label>TAN (Amonio Total mg/L)</label><input type="number" id="water-tan" step="0.001"></div>
                    <div class="input-group"><label>NO2 (Nitritos mg/L)</label><input type="number" id="water-no2" step="0.001"></div>
                    <div class="input-group"><label>Alcalinidad (mg/L CaCO3)</label><input type="number" id="water-alk" step="1"></div>
                    <div class="input-group"><label>Dureza (mg/L CaCO3)</label><input type="number" id="water-hard" step="1"></div>
                    <div class="dashboard-grid">
                        <div class="input-group"><label>Magnesio</label><input type="number" id="water-mg" step="1"></div>
                        <div class="input-group"><label>Potasio</label><input type="number" id="water-k" step="1"></div>
                    </div>
                    <div class="input-group"><label>Fosfatos (PO4)</label><input type="number" id="water-po4" step="0.01"></div>
                </div>

                <button type="button" onclick="saveWaterQuality()" class="primary-btn" style="margin-top: 15px;">GUARDAR PAR√ÅMETROS</button>
            </form>
        </div>
    </section>

    <section id="generic-page" class="hidden">
        <div class="screen-header">
            <button class="back-btn" onclick="navigation.goBack()">&#8592;</button>
            <h3 id="page-title">T√≠tulo</h3>
        </div>
        <div class="content-area"><p>En construcci√≥n...</p></div>
    </section>

</div>

<div id="alarm-overlay" class="hidden">
    <div class="alarm-box">
        <h2>‚ö†Ô∏è ALERTA CR√çTICA ‚ö†Ô∏è</h2>
        <div class="alarm-data">
            <strong id="alarm-pool">Piscina X</strong><br>
            <span id="alarm-date">--/--/--</span> <span id="alarm-time">--:--</span><br>
            <div style="margin:10px 0; font-size:1.4rem; color:#d32f2f;">
                OX√çGENO: <b id="alarm-value">0.0</b> mg/L
            </div>
            Temp: <span id="alarm-temp">--</span>¬∞C
        </div>
        <button class="alarm-btn" onclick="stopAlarm()">ENTENDIDO - APAGAR</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, orderBy, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBBgvzjBdgvSlHiIqyGL3abcG6fHFS-m6I",
      authDomain: "vannamei--data.firebaseapp.com",
      projectId: "vannamei--data",
      storageBucket: "vannamei--data.firebasestorage.app",
      messagingSenderId: "758235885282",
      appId: "1:758235885282:web:a7ad387667a05a1f7778bb",
      measurementId: "G-MN2YM6T1LE"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // --- ID DE SESI√ìN (Para que la alarma no suene en el propio dispositivo) ---
    const SESSION_ID = 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    console.log("ID de Sesi√≥n actual:", SESSION_ID);

    // Fechas por defecto
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('feed-date').value = today;
    document.getElementById('water-date').value = today;
    const now = new Date().toTimeString().split(' ')[0].substring(0,5);
    document.getElementById('water-time').value = now;

    // --- NAVEGACI√ìN ---
    window.navigation = {
        showScreen: (screenId) => {
            document.querySelectorAll('.app-container > section').forEach(el => el.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
            window.scrollTo(0,0);
        },
        goBack: () => window.navigation.showScreen('dashboard-screen'),
        goToGeneric: (title) => {
            document.getElementById('page-title').innerText = title;
            window.navigation.showScreen('generic-page');
        },
        logout: async () => {
            await signOut(auth);
            document.getElementById('password').value = "";
            window.navigation.showScreen('login-screen');
        }
    };

    // --- LOGIN ---
    document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const pass = document.getElementById('password').value;
        const btn = document.getElementById('btn-ingresar');
        const err = document.getElementById('login-error');
        
        btn.innerText = "Verificando..."; btn.disabled = true; err.classList.add('hidden');
        try {
            const cred = await signInWithEmailAndPassword(auth, email, pass);
            document.getElementById('user-display').innerText = cred.user.email;
            window.navigation.showScreen('dashboard-screen');
            // Al entrar, iniciamos la escucha de alarmas
            startAlarmListener(); 
        } catch (error) {
            err.innerText = "Error: Credenciales incorrectas."; err.classList.remove('hidden');
        } finally {
            btn.innerText = "INGRESAR SEGURO"; btn.disabled = false;
        }
    });

    // --- HELPERS (Carga de piscinas gen√©rica) ---
    window.loadPoolsForSelect = async (selectId) => {
        const select = document.getElementById(selectId);
        select.innerHTML = '<option value="">Cargando...</option>';
        try {
            const snap = await getDoc(doc(db, "config", "general"));
            select.innerHTML = '<option value="">Seleccione Piscina</option>';
            if (snap.exists() && snap.data().pools) {
                snap.data().pools.forEach(pool => {
                    const opt = document.createElement('option');
                    opt.value = pool.id; 
                    opt.text = `Piscina ${pool.id}`;
                    select.appendChild(opt);
                });
            }
        } catch (e) { select.innerHTML = '<option value="">Error carga</option>'; }
    };

    // --- GUARDAR CONFIG ---
    window.renderPoolInputs = (val) => {
        const c = document.getElementById('pool-areas-container'); c.innerHTML = '';
        const count = parseInt(val);
        if(!count) return;
        for(let i=1; i<=count; i++) c.innerHTML += `<div class="pool-input-row"><label>Piscina ${i}</label><input type="number" class="pool-area-input" data-id="${i}" placeholder="Has"></div>`;
    };
    window.saveConfig = async () => { /* (Igual que antes, omitido por brevedad pero funcional en copia completa) */ 
        if (!auth.currentUser) return;
        const name = document.getElementById('farm-name').value;
        const count = document.getElementById('pool-count').value;
        const inputs = document.querySelectorAll('.pool-area-input');
        let pools = [];
        inputs.forEach(i => pools.push({ id: i.dataset.id, area: parseFloat(i.value)||0 }));
        await setDoc(doc(db, "config", "general"), { farmName: name, poolCount: parseInt(count), pools, updatedBy: auth.currentUser.email });
        alert("Configuraci√≥n guardada"); window.navigation.goBack();
    };
    window.loadConfig = async () => { /* L√≥gica de carga igual a versiones previas */ 
         try {
            const snap = await getDoc(doc(db, "config", "general"));
            if (snap.exists()) {
                const data = snap.data();
                document.getElementById('farm-name').value = data.farmName;
                document.getElementById('pool-count').value = data.poolCount;
                renderPoolInputs(data.poolCount);
                const inputs = document.querySelectorAll('.pool-area-input');
                data.pools.forEach((p,i) => { if(inputs[i]) inputs[i].value = p.area; });
            }
        } catch(e){}
    };

    // --- ALIMENTACI√ìN ---
    window.saveFeeding = async () => {
        if (!auth.currentUser) return;
        const date = document.getElementById('feed-date').value;
        const pool = document.getElementById('feed-pool-select').value;
        const rec = document.getElementById('feed-recharged').value;
        const cons = document.getElementById('feed-consumed').value;
        if(!date || !pool) return alert("Faltan datos");
        await addDoc(collection(db, "feeding_records"), { date, poolId: pool, recharged: parseFloat(rec)||0, consumed: parseFloat(cons)||0, user: auth.currentUser.email });
        alert("Alimentaci√≥n registrada");
        document.getElementById('feed-consumed').value = "";
    };

    // --- CALIDAD DE AGUA Y ALARMAS (NUEVO) ---
    window.saveWaterQuality = async () => {
        if (!auth.currentUser) return alert("Sesi√≥n finalizada");

        // 1. Recolecci√≥n de Datos
        const data = {
            date: document.getElementById('water-date').value,
            time: document.getElementById('water-time').value,
            poolId: document.getElementById('water-pool-select').value,
            // F√≠sicos
            oxygen: parseFloat(document.getElementById('water-o2').value) || 0,
            temp: parseFloat(document.getElementById('water-temp').value) || 0,
            ph: parseFloat(document.getElementById('water-ph').value) || 0,
            salinity: parseFloat(document.getElementById('water-sal').value) || 0,
            // Qu√≠micos
            tan: parseFloat(document.getElementById('water-tan').value) || 0,
            no2: parseFloat(document.getElementById('water-no2').value) || 0,
            alk: parseFloat(document.getElementById('water-alk').value) || 0,
            hard: parseFloat(document.getElementById('water-hard').value) || 0,
            mg: parseFloat(document.getElementById('water-mg').value) || 0,
            k: parseFloat(document.getElementById('water-k').value) || 0,
            po4: parseFloat(document.getElementById('water-po4').value) || 0,
            
            user: auth.currentUser.email,
            timestamp: new Date()
        };

        if(!data.date || !data.poolId || !document.getElementById('water-o2').value) {
            return alert("Fecha, Piscina y OX√çGENO son obligatorios.");
        }

        const btn = document.querySelector('#water-screen button.primary-btn');
        btn.innerText = "Guardando..."; btn.disabled = true;

        try {
            // 2. Guardar registro normal
            await addDoc(collection(db, "water_quality"), data);

            // 3. VERIFICAR ALARMA (Ox√≠geno <= 3)
            if (data.oxygen <= 3.0) {
                console.warn("ALERTA: Ox√≠geno bajo. Enviando alarma...");
                await addDoc(collection(db, "active_alarms"), {
                    type: "LOW_OXYGEN",
                    poolId: data.poolId,
                    value: data.oxygen,
                    temp: data.temp,
                    date: data.date,
                    time: data.time,
                    timestamp: new Date(), // Importante para ordenar
                    originSessionId: SESSION_ID // MI C√âDULA DE IDENTIDAD DIGITAL
                });
            }

            alert("Datos de agua guardados correctamente.");
            window.navigation.goBack();
        } catch (e) {
            alert("Error: " + e.message);
        } finally {
            btn.innerText = "GUARDAR PAR√ÅMETROS"; btn.disabled = false;
        }
    };

    // --- ESCUCHA DE ALARMAS (El O√≠do Digital) ---
    let unsubscribeAlarm = null;

    function startAlarmListener() {
        if(unsubscribeAlarm) return; // Ya escuchando

        const q = query(collection(db, "active_alarms"), orderBy("timestamp", "desc"), limit(1));
        
        unsubscribeAlarm = onSnapshot(q, (snapshot) => {
            snapshot.docChanges().forEach((change) => {
                if (change.type === "added") {
                    const alarm = change.doc.data();
                    
                    // VALIDACI√ìN 1: ¬øEs una alarma fresca? (menos de 1 min)
                    const alarmTime = alarm.timestamp.toDate();
                    const now = new Date();
                    const diffSeconds = (now - alarmTime) / 1000;
                    
                    if (diffSeconds > 60) return; // Ignorar alarmas viejas al cargar

                    // VALIDACI√ìN 2: ¬øFui yo?
                    if (alarm.originSessionId === SESSION_ID) {
                        console.log("Ignorando mi propia alarma.");
                        return;
                    }

                    // SI LLEGO AQU√ç: ¬°ES UNA EMERGENCIA DE OTRO!
                    triggerVisualAlarm(alarm);
                }
            });
        });
    }

    function triggerVisualAlarm(data) {
        // 1. Llenar datos
        document.getElementById('alarm-pool').innerText = "PISCINA " + data.poolId;
        document.getElementById('alarm-date').innerText = data.date;
        document.getElementById('alarm-time').innerText = data.time;
        document.getElementById('alarm-value').innerText = data.value;
        document.getElementById('alarm-temp').innerText = data.temp;

        // 2. Mostrar Overlay
        const overlay = document.getElementById('alarm-overlay');
        overlay.classList.remove('hidden');

        // 3. Tocar Sonido
        const audio = document.getElementById('alarm-sound');
        audio.currentTime = 0;
        audio.play().catch(e => console.log("Navegador bloque√≥ el audio autom√°tico:", e));
        
        // Vibrar si es m√≥vil
        if(navigator.vibrate) navigator.vibrate([500, 200, 500, 200, 1000]);
    }

    // Funci√≥n global para apagar
    window.stopAlarm = () => {
        document.getElementById('alarm-overlay').classList.add('hidden');
        document.getElementById('alarm-sound').pause();
    };

    document.getElementById('toggle-pwd-btn').addEventListener('click', () => {
        const i = document.getElementById('password'); i.type = i.type === 'password' ? 'text' : 'password';
    });

</script>
</body>
</html>
