<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vannamei Data - Gesti√≥n Acu√≠cola</title>
    <style>
        /* --- ESTILOS (CSS) --- */
        :root { --primary-color: #006064; --secondary-color: #0097a7; --bg-color: #f4f6f8; --text-color: #333; --white: #ffffff; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-color); margin: 0; padding: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; color: var(--text-color); }
        .app-container { width: 100%; max-width: 480px; background: var(--white); min-height: 100vh; box-shadow: 0 0 20px rgba(0,0,0,0.1); position: relative; display: flex; flex-direction: column; }
        .hidden { display: none !important; }
        
        /* Login */
        #login-screen { flex: 1; display: flex; flex-direction: column; justify-content: center; padding: 2rem; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; }
        h1, h2, h3 { text-align: center; margin-bottom: 1rem; }
        .input-group { position: relative; margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; box-sizing: border-box; background: #fff; }
        input:focus, select:focus { outline: 2px solid var(--secondary-color); border-color: transparent; }
        
        button.primary-btn { width: 100%; padding: 14px; background-color: var(--primary-color); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        button:disabled { opacity: 0.7; cursor: not-allowed; }
        
        .toggle-password { position: absolute; right: 10px; top: 38px; cursor: pointer; background: none; border: none; color: #666; }
        #login-screen .toggle-password { top: 50%; transform: translateY(-50%); color: #ddd; }
        
        /* Headers */
        .screen-header { background-color: var(--primary-color); color: white; padding: 1rem; display: flex; align-items: center; position: sticky; top: 0; z-index: 10; }
        .back-btn { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; margin-right: 1rem; padding: 0 10px; }
        .content-area { padding: 1.5rem; flex: 1; overflow-y: auto; padding-bottom: 4rem; }
        
        /* Dashboard Grid */
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .dash-btn { background-color: var(--white); border: 1px solid #ddd; border-radius: 12px; padding: 1.5rem 1rem; text-align: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.05); color: var(--primary-color); font-weight: 600; display: flex; align-items: center; justify-content: center; }
        
        /* Config & Forms */
        .pool-input-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; background: #f9f9f9; padding: 8px; border-radius: 6px; }
        .pool-input-row label { margin: 0; font-weight: normal; }
        .pool-input-row input { width: 80px; text-align: center; }
        #login-error { color: #ffcdd2; text-align: center; margin-top: 10px; font-size: 0.9rem; }
    </style>
</head>
<body>

<div class="app-container">
    
    <section id="login-screen">
        <h2>Vannamei Data</h2>
        <p style="text-align: center; opacity: 0.9; margin-top: -10px;">Gesti√≥n Productiva</p>
        <form id="login-form">
            <div class="input-group">
                <input type="email" id="email" placeholder="Usuario" required autocomplete="username" value="vannameidata@gmail.com">
            </div>
            <div class="input-group">
                <input type="password" id="password" placeholder="Contrase√±a" required autocomplete="current-password">
                <button type="button" class="toggle-password" id="toggle-pwd-btn">üëÅÔ∏è</button>
            </div>
            <button type="submit" class="primary-btn" id="btn-ingresar">INGRESAR SEGURO</button>
            <div id="login-error" class="hidden"></div>
        </form>
    </section>

    <section id="dashboard-screen" class="hidden">
        <div class="screen-header">
            <button class="back-btn" onclick="navigation.logout()">&#8592;</button>
            <h3>Panel de Control</h3>
        </div>
        <div class="content-area">
            <p>Bienvenido, <span id="user-display" style="font-weight:bold; color:var(--primary-color);">Cargando...</span></p>
            <div class="dashboard-grid">
                <button class="dash-btn" onclick="navigation.showScreen('config-screen'); loadConfig();">Configuraci√≥n de Piscinas</button>
                <button class="dash-btn" onclick="navigation.showScreen('feeding-screen'); loadPoolsForFeeding();">Registro de Alimentaci√≥n</button>
                
                <button class="dash-btn" onclick="navigation.goToGeneric('Calidad de Agua')">Calidad de Agua</button>
                <button class="dash-btn" onclick="navigation.goToGeneric('Biometr√≠as')">Biometr√≠as</button>
                <button class="dash-btn" onclick="navigation.goToGeneric('Estatus de Piscinas')">Estatus de Piscinas</button>
            </div>
        </div>
    </section>

    <section id="config-screen" class="hidden">
        <div class="screen-header">
            <button class="back-btn" onclick="navigation.goBack()">&#8592;</button>
            <h3>Configuraci√≥n</h3>
        </div>
        <div class="content-area">
            <form id="config-form">
                <div class="input-group">
                    <label>Nombre de la Granja</label>
                    <input type="text" id="farm-name" placeholder="Ej: Santa Clara" required>
                </div>
                <div class="input-group">
                    <label>Cantidad de Piscinas</label>
                    <input type="number" id="pool-count" placeholder="0" min="1" max="50" oninput="renderPoolInputs(this.value)">
                </div>
                <div style="border-top: 1px solid #eee; margin: 20px 0;"></div>
                <div id="pool-areas-container"></div>
                <button type="button" onclick="saveConfig()" class="primary-btn" style="margin-top: 20px;">GUARDAR</button>
            </form>
        </div>
    </section>

    <section id="feeding-screen" class="hidden">
        <div class="screen-header">
            <button class="back-btn" onclick="navigation.goBack()">&#8592;</button>
            <h3>Alimentaci√≥n</h3>
        </div>
        <div class="content-area">
            <form id="feeding-form">
                
                <div class="input-group">
                    <label>Fecha del Registro</label>
                    <input type="date" id="feed-date" required>
                </div>

                <div class="input-group">
                    <label>Seleccionar Piscina</label>
                    <select id="feed-pool-select" required>
                        <option value="">Cargando piscinas...</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>Kilos Recargados (Alimentador)</label>
                    <input type="number" id="feed-recharged" placeholder="0.00" step="0.01">
                </div>

                <div class="input-group">
                    <label>Kilos Consumidos</label>
                    <input type="number" id="feed-consumed" placeholder="0.00" step="0.01" required>
                </div>

                <button type="button" onclick="saveFeeding()" class="primary-btn" style="margin-top: 10px;">GUARDAR REGISTRO</button>
            </form>
        </div>
    </section>

    <section id="generic-page" class="hidden">
        <div class="screen-header">
            <button class="back-btn" onclick="navigation.goBack()">&#8592;</button>
            <h3 id="page-title">T√≠tulo</h3>
        </div>
        <div class="content-area">
            <p>M√≥dulo: <span id="page-content-name"></span> (En construcci√≥n)</p>
        </div>
    </section>

</div>

<script type="module">
    // Importamos AUTHENTICATION + FIRESTORE (A√±adido 'collection' y 'addDoc')
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBBgvzjBdgvSlHiIqyGL3abcG6fHFS-m6I",
      authDomain: "vannamei--data.firebaseapp.com",
      projectId: "vannamei--data",
      storageBucket: "vannamei--data.firebasestorage.app",
      messagingSenderId: "758235885282",
      appId: "1:758235885282:web:a7ad387667a05a1f7778bb",
      measurementId: "G-MN2YM6T1LE"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // --- CONFIGURACI√ìN INICIAL ---
    // Poner fecha de hoy autom√°ticamente en los inputs de fecha
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('feed-date').value = today;

    // --- NAVEGACI√ìN ---
    window.navigation = {
        showScreen: (screenId) => {
            document.querySelectorAll('.app-container > section').forEach(el => el.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
            window.scrollTo(0,0);
        },
        goBack: () => window.navigation.showScreen('dashboard-screen'),
        goToGeneric: (title) => {
            document.getElementById('page-title').innerText = title;
            document.getElementById('page-content-name').innerText = title;
            window.navigation.showScreen('generic-page');
        },
        logout: async () => {
            await signOut(auth);
            document.getElementById('password').value = "";
            window.navigation.showScreen('login-screen');
        }
    };

    // --- LOGIN ---
    document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const pass = document.getElementById('password').value;
        const btn = document.getElementById('btn-ingresar');
        const err = document.getElementById('login-error');
        
        btn.innerText = "Verificando..."; btn.disabled = true; err.classList.add('hidden');

        try {
            const userCredential = await signInWithEmailAndPassword(auth, email, pass);
            document.getElementById('user-display').innerText = userCredential.user.email;
            window.navigation.showScreen('dashboard-screen');
        } catch (error) {
            console.error(error);
            err.innerText = "Error: Credenciales incorrectas.";
            err.classList.remove('hidden');
        } finally {
            btn.innerText = "INGRESAR SEGURO"; btn.disabled = false;
        }
    });

    // --- M√ìDULO 1: CONFIGURACI√ìN ---
    window.renderPoolInputs = (val) => {
        const container = document.getElementById('pool-areas-container');
        container.innerHTML = '';
        const count = parseInt(val);
        if(!count || count < 0) return;
        for(let i = 1; i <= count; i++) {
            container.innerHTML += `<div class="pool-input-row"><label>Piscina ${i}</label><input type="number" step="0.01" class="pool-area-input" data-id="${i}" placeholder="Has"></div>`;
        }
    };

    window.saveConfig = async () => {
        if (!auth.currentUser) return alert("Sesi√≥n expirada");
        const farmName = document.getElementById('farm-name').value;
        const poolCount = document.getElementById('pool-count').value;
        const inputs = document.querySelectorAll('.pool-area-input');
        let pools = [];
        inputs.forEach(input => pools.push({ id: input.dataset.id, area: parseFloat(input.value) || 0 }));

        if(!farmName || !poolCount) return alert("Faltan datos");
        
        const btn = document.querySelector('#config-screen button.primary-btn');
        btn.innerText = "Guardando..."; btn.disabled = true;

        try {
            await setDoc(doc(db, "config", "general"), {
                farmName, poolCount: parseInt(poolCount), pools,
                updatedBy: auth.currentUser.email
            });
            alert("Configuraci√≥n guardada");
            window.navigation.goBack();
        } catch (error) { alert("Error: " + error.message); } 
        finally { btn.innerText = "GUARDAR"; btn.disabled = false; }
    };

    window.loadConfig = async () => {
        if (!auth.currentUser) return;
        try {
            const snap = await getDoc(doc(db, "config", "general"));
            if (snap.exists()) {
                const data = snap.data();
                document.getElementById('farm-name').value = data.farmName || '';
                document.getElementById('pool-count').value = data.poolCount || '';
                renderPoolInputs(data.poolCount);
                const inputs = document.querySelectorAll('.pool-area-input');
                data.pools.forEach((p, i) => { if(inputs[i]) inputs[i].value = p.area; });
            }
        } catch (e) { console.log("Sin datos"); }
    };

    // --- M√ìDULO 2: ALIMENTACI√ìN (NUEVO) ---
    
    // Funci√≥n para cargar el selector de piscinas basado en la Configuraci√≥n
    window.loadPoolsForFeeding = async () => {
        const select = document.getElementById('feed-pool-select');
        select.innerHTML = '<option value="">Cargando...</option>';
        
        try {
            // Leemos la configuraci√≥n guardada para saber cu√°ntas piscinas hay
            const snap = await getDoc(doc(db, "config", "general"));
            select.innerHTML = '<option value="">Seleccione Piscina</option>';
            
            if (snap.exists()) {
                const data = snap.data();
                // Creamos una opci√≥n por cada piscina configurada
                if(data.pools && data.pools.length > 0) {
                    data.pools.forEach(pool => {
                        const option = document.createElement('option');
                        option.value = pool.id; // Guardamos el ID (ej: "1", "2")
                        option.text = `Piscina ${pool.id} (${pool.area} Has)`;
                        select.appendChild(option);
                    });
                }
            } else {
                alert("Primero debes configurar la granja en 'Configuraci√≥n de Piscinas'");
                window.navigation.goBack();
            }
        } catch (e) {
            console.error(e);
            select.innerHTML = '<option value="">Error al cargar</option>';
        }
    };

    // Funci√≥n para Guardar el Registro Diario
    window.saveFeeding = async () => {
        if (!auth.currentUser) return alert("Sesi√≥n expirada");

        const date = document.getElementById('feed-date').value;
        const poolId = document.getElementById('feed-pool-select').value;
        const recharged = parseFloat(document.getElementById('feed-recharged').value) || 0;
        const consumed = parseFloat(document.getElementById('feed-consumed').value) || 0;

        if(!date || !poolId) {
            alert("Por favor selecciona Fecha y Piscina.");
            return;
        }

        const btn = document.querySelector('#feeding-screen button.primary-btn');
        btn.innerText = "Guardando..."; btn.disabled = true;

        try {
            // Guardamos en una colecci√≥n nueva llamada 'feeding_records'
            await addDoc(collection(db, "feeding_records"), {
                date: date,
                poolId: poolId,
                kilosRecharged: recharged,
                kilosConsumed: consumed,
                userId: auth.currentUser.email,
                timestamp: new Date()
            });

            alert("Registro de alimentaci√≥n guardado correctamente.");
            
            // Limpiar campos (excepto fecha y piscina para facilitar ingreso r√°pido de la siguiente)
            document.getElementById('feed-recharged').value = "";
            document.getElementById('feed-consumed').value = "";
            
        } catch (error) {
            console.error("Error al guardar:", error);
            alert("Error: " + error.message);
        } finally {
            btn.innerText = "GUARDAR REGISTRO"; btn.disabled = false;
        }
    };

    // UI Helpers
    document.getElementById('toggle-pwd-btn').addEventListener('click', () => {
        const i = document.getElementById('password'); i.type = i.type === 'password' ? 'text' : 'password';
    });
</script>
</body>
</html>
